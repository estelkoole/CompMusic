---
title: "A comparison of sad playlists"
output: 
  flexdashboard::flex_dashboard:
    self_contained: false
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
library(readr)
library(lubridate)
library(ggplot2)
library(tidyverse)
library(spotifyr)
library(compmus)
library(plotly)
library(tidymodels)
library(ggdendro)
library(heatmaply)

urgh <- get_playlist_audio_features('', '3zHgInxVVBHhge5rc71TBk?si=fbb92d3bd6134cbb')
nostalgia <- get_playlist_audio_features('', '6WjvDxvrtZHQO0I4sjhWcG?si=bf12bda2f6444809')
spelen <- get_playlist_audio_features('', '75aP68kX1ZjvXTLFmwAn1N?si=f94ac20a680343ac')

all_songs <- get_playlist_audio_features('', '12K480rqESLeIc9bbGfoUA?si=77b1c31fd8cd4794')
sad_lists <- rbind(urgh, nostalgia, spelen)
```

Introduction
===================================== 

Intro {data-width=400}
-----------------------------------------------------------------------

### Intro

What music do people listen to when they feel down? \
A comparison of three playlists from two friends and myself

Introductory part about music and emotion: \
On spotify you will find many playlist with 'music to cry your heart out to' or 'sad songs', music to soothe or to swoon in. I think it would be very interesting to compare two of these playlists and see what the recurring characteristics are, or that maybe different people have very different musical needs when they feel down. The comparison point herein will probably be in the ambience, tempo and chords of the music. \
These three playlists will be very subjective and probably differ much depending on the creators that are chosen. Because of this, it could be hard to generalize the answer to this question.

### Background

The following three playlists will be used:

Nostalgia<3 van Lot \
spelen:) van Puck \
urgh van Es \

It would be interesting to see from which standpoint the playlists were created and how they percieve the type of music in their playlist.


urgh {data-width=200}
-----------------------------------------------------------------------

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/3zHgInxVVBHhge5rc71TBk?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

spelen:) {data-width=200}
-----------------------------------------------------------------------

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/3zHgInxVVBHhge5rc71TBk?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>

Nostalgia<3 {data-width=200}
-----------------------------------------------------------------------

<iframe style="border-radius:12px" src="https://open.spotify.com/embed/playlist/3zHgInxVVBHhge5rc71TBk?utm_source=generator" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>


Feeling of the music
===================================== 

Plot 1 {data-width=500}
-----------------------------------------------------------------------
### Plot 1

```{r}
plot1 <- ggplot(sad_lists, aes(x = playlist_name, y = valence)) + geom_violin()

plot1
```

Plot 2 {data-width=500}
-----------------------------------------------------------------------
### Plot 2

```{r}
plot2 <- ggplot(sad_lists, aes(text = track.name, x = tempo, y = loudness, size = valence, color='pink')) + geom_point() + facet_wrap(~playlist_name)

ggplotly(plot2)
```

Analyzing tempo
===================================== 



Analyzing harmonies
===================================== 

A Chromogram from Love on Top {data-width=500}
-----------------------------------------------------------------------

A Chromogram from Love on Top

### bey plot

```{r}
bey <-
  get_tidy_audio_analysis("1z6WtY7X4HQJvzxC4UgkSf?si=70c6212969b84b27") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

bey |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |> 
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_minimal() +
  scale_fill_viridis_c()
```


Clustering the songs
===================================== 

```{r}

get_conf_mat <- function(fit) {
  outcome <- .get_tune_outcome_names(fit)
  fit |> 
    collect_predictions() |> 
    conf_mat(truth = outcome, estimate = .pred_class)
}  

get_pr <- function(fit) {
  fit |> 
    conf_mat_resampled() |> 
    group_by(Prediction) |> mutate(precision = Freq / sum(Freq)) |> 
    group_by(Truth) |> mutate(recall = Freq / sum(Freq)) |> 
    ungroup() |> filter(Prediction == Truth) |> 
    select(class = Prediction, precision, recall)
}  

halloween <-
  get_playlist_audio_features("bnfcollection", "12K480rqESLeIc9bbGfoUA?si=77b1c31fd8cd4794") |>
  add_audio_analysis() |>
  mutate(
    segments = map2(segments, key, compmus_c_transpose),
    pitches =
      map(segments,
          compmus_summarise, pitches,
          method = "mean", norm = "manhattan"
      ),
    timbre =
      map(
        segments,
        compmus_summarise, timbre,
        method = "mean"
      )
  ) |>
  mutate(pitches = map(pitches, compmus_normalise, "clr")) |>
  mutate_at(vars(pitches, timbre), map, bind_rows) |>
  unnest(cols = c(pitches, timbre))

halloween_juice <-
  recipe(
    track.name ~
      danceability +
      energy +
      loudness +
      speechiness +
      acousticness +
      instrumentalness +
      liveness +
      valence +
      tempo +
      duration,
    data = halloween
  ) |>
  step_center(all_predictors()) |>
  step_scale(all_predictors()) |> 
  # step_range(all_predictors()) |> 
  prep(halloween |> mutate(track.name = str_trunc(track.name, 40))) |>
  juice() |>
  column_to_rownames("track.name")

halloween_dist <- dist(halloween_juice, method = "euclidean")

halloween_dist |> 
  hclust(method = "complete") |> # Try single, average, and complete.
  dendro_data() |>
  ggdendrogram()
```

Idea !! Take 5 new songs and ask the three playlist creators if they'd want the song in their playlist or not and then let a clustering algorithm go on that and see if it's correlated.

Do some random forest training to find the most interesting features in the data set! check week of dendograms